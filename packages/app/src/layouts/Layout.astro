---
import { getRuntime } from '@astrojs/cloudflare/runtime';

import type { Env } from '../env';

import Search from '../components/Search';
import Dropdown from '../components/Dropdown.astro';
import { types, fansubs } from '../constant';

export interface Props {
  title: string;
}

const { title } = Astro.props;

const url = Astro.url.pathname;
const search = Astro.url.searchParams;

const searchParams = new URLSearchParams(Astro.url.search);
searchParams.delete('cmd');
const feed = `/feed.xml${searchParams.size > 0 ? '?' + searchParams.toString() : ''}`;
const page = Astro.params.page ?? Astro.url.searchParams.get('page') ?? '1';
const enableFeed = page === '1' && !Astro.url.pathname.startsWith('/resource/');

const runtime = getRuntime<Env>(Astro.request);
const timestamp = new Date((await runtime?.env.animegarden.get('state/refresh-timestamp')) ?? 0);

const hasFansubSearch = search.has('fansub');

function followSearch(params: Record<string, string>) {
  const s = new URLSearchParams(search);
  for (const [key, value] of Object.entries(params)) {
    s.set(key, value);
  }
  return s.toString();
}
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content="動漫花園 3-rd party mirror site and API endpoint">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml">
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
  </head>
  <body>
    <header class="w-full pt-8vh bg-[#fef8f7] border-b">
      <h1 class="text-4xl pb-10rem font-quicksand font-bold text-center select-none">
        <a href="/">🌸 Anime Garden</a>
      </h1>
      <div class="relative z-100">
        <div class="vercel absolute top-[-7rem] w-full flex justify-center">
          <Search client:only />
        </div>
      </div>
      <div class="main flex gap6 hide-scrollbar justify-between select-none text-base-500">
        <div class="flex gap6 justify-start">
          <a href="/" class="header-item block" x-active={url === '/'}>首页</a>
          <a
            href="/resources/1"
            class="header-item block"
            x-active={url.startsWith('/resources/') && !search.has('type') && !search.has('fansub')}
            >所有资源</a
          >
          <div class="header-item cursor-pointer" x-active={search.has('type')}>
            <Dropdown>
              <span>类型</span>
              <div slot="dropdown" class="mt4">
                <div
                  class="w-[120px] max-h-[600px] overflow-y-auto rounded-md border shadow-box bg-light-100 divide-y"
                >
                  {
                    types.map((t) => (
                      <a
                        href={`/resources/1?${followSearch({ type: t })}`}
                        class="px2 py1 block text-base-600 text-link-active"
                      >
                        {t}
                      </a>
                    ))
                  }
                </div>
              </div>
            </Dropdown>
          </div>
          <div class="header-item cursor-pointer" x-active={search.has('fansub')}>
            <Dropdown>
              <span>字幕组</span>
              <div slot="dropdown" class="mt4">
                <div
                  class="w-[180px] max-h-[600px] overflow-y-auto rounded-md border shadow-box bg-light-100 divide-y"
                >
                  {
                    hasFansubSearch && (
                      <a
                        href={`/resources/1?${followSearch({ fansub: '' })}`}
                        class="px2 py1 block text-base-600 text-link-active"
                      >
                        所有
                      </a>
                    )
                  }
                  {
                    fansubs.map((t) => (
                      <a
                        href={`/resources/1?${followSearch({ fansub: '' + t.id })}`}
                        class="px2 py1 block text-base-600 text-link-active"
                      >
                        {t.name}
                      </a>
                    ))
                  }
                </div>
              </div>
            </Dropdown>
          </div>
          <a href="https://share.dmhy.org/" target="_blank" class="header-item block">动漫花园</a>
        </div>
        <div>
          {
            enableFeed && (
              <a href={feed} target="_blank" class="header-item lt-sm:hidden block text-[#ee802f] hover:(!text-[#ff7800] !border-b-[#ff7800])">
                <span class="i-carbon-rss mr1"></span><span>RSS</span>
              </a>)
          }
        </div>
      </div>
    </header>
    <main class="main pb-8vh">
      <slot />
    </main>
    <footer class="main pb-8vh" select-none>
      <div font-sm text-base-400>
        <a href="https://github.com/yjl9903" target="_blank" class="text-link-active">XLor</a>
        <span> © 2023</span>
      </div>
      <div font-sm text-base-400>
        Refreshed at {timestamp.toLocaleString('zh-CN', { timeZone: 'Asia/ShangHai' })}
      </div>
      <div font-sm text-base-400>Powered by Astro</div>
      <div font-sm text-base-400>Hosted on Cloudflare Pages</div>
    </footer>
  </body>
</html>

<style is:global>
  @import '@onekuma/preset.css';
  @import '@onekuma/reset/tailwind.css';

  :root {
    /* --accent: 124, 58, 237; */
    --accent: 0, 204, 170;
    --accent-gradient: linear-gradient(
      45deg,
      rgb(var(--accent)),
      /* #da62c4 30%, */ #08c,
      white 60%
    );

    --color-bg-primary: #fcfcfc;
    --color-bg-secondary: #fafafa;
  }

  html {
    background-color: var(--color-bg-primary);

    --at-apply: font-sans;
  }

  code {
    --at-apply: font-mono;
  }

  .main {
    --at-apply: mx-w-[90vw] lg:w-[80vw] md:w-[46rem] lt-md:mx-w-[95vw] lt-md:w-[95vw];
    --at-apply: mx-auto;
  }

  .text-gradient {
    background-image: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 400%;
    background-position: 0%;
  }

  .text-link {
    --at-apply: text-sky-700 hover:text-sky-500;
  }

  .text-link-active {
    --at-apply: hover:text-sky-600;
  }

  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;  /* Safari and Chrome */
  }

  /* Header style */
  .header-item {
    --at-apply: py2 border-b border-b-3 border-transparent w-max;
    --at-apply: hover:text-base-800 hover:border-dark-700;
  }

  .header-item[x-active] {
    --at-apply: border-orange-500;
  }
</style>
