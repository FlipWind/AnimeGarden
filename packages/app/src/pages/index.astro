---
import type { FullBangumi } from 'bgmd/dist/types';
import { calendar as rawCalendar } from 'bgmd/calendar';

import Layout from '../layouts/Layout.astro';

import Pagination from '../components/Pagination.astro';
import ResourceTable from '../components/ResourceTable.astro';
import ErrorNotification from '../components/Error.astro';

import { getRuntimeEnv } from '../utils';
import { wfetch, fetchResources } from '../fetch';

const first = (new Date().getDay() + 6) % 7;
const calendar = rawCalendar.map((_, idx) => {
  const index = (idx + first) % 7;
  return {
    index: index + 1,
    text: ['一', '二', '三', '四', '五', '六', '日'][index],
    bangumis: rawCalendar[index]
  };
});

function getPosterImage(bgm: FullBangumi) {
  if (bgm.tmdb?.poster_path) {
    return `https://www.themoviedb.org/t/p/w300_and_h450_bestv2${bgm.tmdb.poster_path}`;
  } else if (bgm.bangumi?.images) {
    return bgm.bangumi.images.large;
  }
}

function getDisplayName(bgm: FullBangumi) {
  if (bgm.bangumi) {
    return bgm.bangumi.name_cn || bgm.name;
  }
  return bgm.name;
}

const env = getRuntimeEnv(Astro.locals);

const { ok, resources, timestamp } = await fetchResources(
  { page: 1, pageSize: 80, type: '動畫' },
  { fetch: wfetch(env?.worker) }
);
---

<Layout title="Anime Garden" timestamp={timestamp}>
  <div class="mt-4vh w-full">
    <div class="space-y-4 w-full mb-8">
      {
        calendar.map((cal) => (
          <div class="w-full">
            <div class="text-xl font-bold mb-2">星期{cal.text}</div>
            <div class="flex w-full space-x-6 overflow-x-auto">
              {cal.bangumis.map((bgm) => (
                <div class="block w-max">
                  <div class="w-150px h-225px flex items-center select-none">
                    <img src={getPosterImage(bgm)} alt="" class="rounded-md max-h-225px" />
                  </div>
                  <div class="w-150px truncate py-2">
                    <span class="font-bold text-sm">{getDisplayName(bgm)}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))
      }
    </div>
    {
      ok ? (
        <>
          <ResourceTable resources={resources} />
          <Pagination page={1} go={(page) => `/resources/${page}?type=動畫`} hasPrev={false} />
        </>
      ) : (
        <ErrorNotification />
      )
    }
  </div>
</Layout>
