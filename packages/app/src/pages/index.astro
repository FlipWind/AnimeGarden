---
import { calendar as rawCalendar } from 'bgmd/calendar';

import Layout from '../layouts/Layout.astro';

import Pagination from '../components/Pagination.astro';
import ResourceTable from '../components/ResourceTable.astro';
import ErrorNotification from '../components/Error.astro';

import { getRuntimeEnv } from '../utils';
import { wfetch, fetchResources } from '../fetch';

const first = (new Date().getDay() + 6) % 7;
const calendar = rawCalendar.map((_, idx) => {
  const index = (idx + first) % 7;
  return {
    index: index + 1,
    text: ['一', '二', '三', '四', '五', '六', '日'][index],
    bangumis: rawCalendar[index]
  };
});

const env = getRuntimeEnv(Astro.locals);

const { ok, resources, timestamp } = await fetchResources(
  { page: 1, pageSize: 80, type: '動畫' },
  { fetch: wfetch(env?.worker) }
);
---

<Layout title="Anime Garden" timestamp={timestamp}>
  <div class="mt-4vh w-full">
    <div class="space-y-4 w-full mb-8">
      {
        calendar.map((cal) => (
          <div class="w-full">
            <div class="text-lg font-bold mb-2">星期{cal.text}</div>
            <div class="flex w-full space-x-4 overflow-x-auto">
              {cal.bangumis.map((bgm) => (
                <div class="block w-max">
                  <div class="w-160px">
                    <img src={bgm.bangumi?.images.large} alt="" class="rounded-md" />
                  </div>
                  <div>
                    <span>{bgm.name}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))
      }
    </div>
    {
      ok ? (
        <>
          <ResourceTable resources={resources} />
          <Pagination page={1} go={(page) => `/resources/${page}?type=動畫`} hasPrev={false} />
        </>
      ) : (
        <ErrorNotification />
      )
    }
  </div>
</Layout>
