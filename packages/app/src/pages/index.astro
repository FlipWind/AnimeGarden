---
import { getRuntime } from '@astrojs/cloudflare/runtime';

import Layout from '../layouts/Layout.astro';
import ResourceTable from '../components/ResourceTable.astro';
import Pagination from '../components/Pagination.astro';

import type { Env } from '../env';
import { wfetch, fetchResources } from '../fetch';

const runtime = getRuntime<Env>(Astro.request);

const { resources } = await fetchResources(1, { fetch: wfetch(runtime?.env?.worker?.fetch) });

try {
  const fet = runtime?.env?.worker?.fetch;
  if (fet) {
    console.log(`Try fetch something with service binding`);
    console.log(`Fetch is ` + typeof fet);
    console.log(Object.entries(runtime?.env));
    const resp = await fet(new Request(`/api`));
    const body = await resp.json();
    console.log(JSON.stringify(body, null, 2));
  }
} catch (err) {
  console.error(err);
}
---

<Layout title="Anime Garden">
  <div class="mt-4vh w-full">
    <ResourceTable resources={resources} />
    <Pagination page={1} href={(page) => `/resources/${page}`} />
  </div>
</Layout>
