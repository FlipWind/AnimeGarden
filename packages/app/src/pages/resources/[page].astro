---
import { format } from 'date-fns';
import { parseSearchURL } from 'animegarden';
import { getRuntime } from '@astrojs/cloudflare/runtime';

import Layout from '../../layouts/Layout.astro';
import Pagination from '../../components/Pagination.astro';
import ResourceTable from '../../components/ResourceTable.astro';

import { Env } from '../../env';
import { removeQuote } from '../../utils';
import { fansubs, QueryType } from '../../constant';
import { wfetch, fetchResources } from '../../fetch';

const { page: _page } = Astro.params;
const page = _page ? +_page : 1;

const url = Astro.url;
const params = parseSearchURL(Astro.url.searchParams);

const publisherId = params.publisherId;
const fansubId = params.fansubId;
const fansub = fansubs.find((f) => f.id === fansubId);
const type = params.type && params.type in QueryType ? QueryType[params.type] : params.type;
const after = params.after;
const before = params.before;

const search = params.search;
const include = params.include;
const isComplicated = include?.some((i) => Array.isArray(i)) ?? false;
const exclude = params.exclude;

const runtime = getRuntime<Env>(Astro.request);

const {
  ok,
  resources,
  filter: searchParams
} = await fetchResources(page, params, {
  fetch: wfetch(runtime?.env?.worker)
});

const keywords = {
  search: searchParams?.search ? removeQuote(searchParams.search) : [...(search ?? [])],
  include: searchParams?.include ? searchParams.include : [...(include ?? [])],
  exclude: searchParams?.exclude ? searchParams.exclude : [...(exclude ?? [])]
};
---

<Layout title="所有资源 | Anime Garden">
  <div class="mt-4vh w-full">
    {
      ok ? (
        <>
          {(search || include || before || after || fansub) && (
            <>
              <div class="mb4 p4 w-full bg-gray-100 rounded-md space-y-2">
                {fansub && (
                  <div class="space-x-2 select-none text-0">
                    <span class="text-4 text-base-800 font-bold inline-block mr2">字幕组</span>
                    <a
                      href={`/resources/1?fansub=${fansub.id}`}
                      class="text-4 select-text text-link"
                    >
                      {fansub.name}
                    </a>
                  </div>
                )}
                {after && (
                  <div class="space-x-2 select-none text-0">
                    <span class="text-4 text-base-800 font-bold inline-block mr2">搜索开始于</span>
                    <span class="text-4 select-text">
                      {format(after, 'yyyy 年 M 月 d 日 hh:mm')}
                    </span>
                  </div>
                )}
                {before && (
                  <div class="space-x-2 select-none text-0">
                    <span class="text-4 text-base-800 font-bold inline-block mr2">搜索结束于</span>
                    <span class="text-4 select-text">
                      {format(before, 'yyyy 年 M 月 d 日 hh:mm')}
                    </span>
                  </div>
                )}
                {keywords.search.length > 0 && (
                  <div class="space-x-2 text-0">
                    {/* prettier-ignore */}
                    <span class="text-4 select-none text-base-800 font-bold mr2 inline-block">模糊匹配</span>
                    {keywords.search.map((i) => (
                      <span class="text-4 select-text underline underline-dotted underline-gray-500">
                        {i}
                      </span>
                    ))}
                  </div>
                )}
                {keywords.include.length > 0 && (
                  <div class="space-x-2 select-none text-0">
                    <span class="text-4 text-base-800 font-bold inline-block mr2">包含关键词</span>
                    {keywords.include.map((i, idx) => (
                      <>
                        {idx > 0 && isComplicated && <span class="text-4 text-base-500">+</span>}
                        {Array.isArray(i) ? (
                          <>
                            {keywords.include.length > 1 && i.length > 1 && (
                              <span class="text-4 text-base-500">&#40;</span>
                            )}
                            {i.map((t, idx) => (
                              <>
                                {idx > 0 && <span class="text-4 text-base-500 mx1">|</span>}
                                {/* prettier-ignore */}
                                <span class="text-4 select-text underline underline-dotted underline-gray-500">{t}</span>
                              </>
                            ))}
                            {keywords.include.length > 1 && i.length > 1 && (
                              <span class="text-4 text-base-500">&#41;</span>
                            )}
                          </>
                        ) : (
                          <>
                            {/* prettier-ignore */}
                            <span class="text-4 select-text underline underline-dotted underline-gray-500">{i}</span>
                          </>
                        )}
                      </>
                    ))}
                  </div>
                )}
                {keywords.exclude.length > 0 && (
                  <div class="space-x-2 text-0">
                    {/* prettier-ignore */}
                    <span class="text-4 select-none text-base-800 font-bold mr2 inline-block">排除关键词</span>
                    {keywords.exclude.map((i) => (
                      <span class="text-4 select-text">{i}</span>
                    ))}
                  </div>
                )}
              </div>
            </>
          )}
          <ResourceTable resources={resources} />
          <Pagination page={page} href={(page) => `/resources/${page}${url.search}`} />
        </>
      ) : (
        <>
          <div class="h-20 text-2xl text-red-700/80 flex items-center justify-center">
            <span class="mr2 i-carbon-error" />
            <span>发生错误</span>
          </div>
        </>
      )
    }
  </div>
</Layout>
