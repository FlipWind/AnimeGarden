---
import { format } from 'date-fns';

import Layout from '../../layouts/Layout.astro';
import Pagination from '../../components/Pagination.astro';
import ResourceTable from '../../components/ResourceTable.astro';

import { fetchResources } from '../../fetch';
import { fansubs, QueryType } from '../../constant';

const { page: _page } = Astro.params;
const page = _page ? +_page : 1;

const url = Astro.url;
const publisher = url.searchParams.get('publisher');
const fansub = url.searchParams.get('fansub');
const fansubItem = fansubs.find((f) => String(f.id) === fansub);

const _type = url.searchParams.get('type');
const type = _type && _type in QueryType ? QueryType[_type] : _type;

const _after = url.searchParams.get('after');
const after = _after ? new Date(_after) : undefined;
const _before = url.searchParams.get('before');
const before = _before ? new Date(_before) : undefined;

const _include = url.searchParams.get('include');
const include: string[] | undefined = _include ? JSON.parse(_include) : undefined;
const _exclude = url.searchParams.get('exclude');
const exclude: string[] | undefined = _exclude ? JSON.parse(_exclude) : undefined;

const resources = await fetchResources(page, {
  publisher: publisher ? +publisher : undefined,
  fansub: fansub ? +fansub : undefined,
  type: type ? type : undefined,
  include,
  exclude,
  after,
  before
});
---

<Layout title="所有资源 | Anime Garden">
  <div class="mt-4vh w-full">
    {
      (include || exclude || before || after || fansubItem) && (
        <>
          <div class="mb4 p4 w-full bg-gray-100 rounded-md space-y-2">
            {fansubItem && (
              <div class="space-x-1 select-none">
                <span class="text-base-800 font-bold inline-block">字幕组</span>
                <a href={`/resources/1?fansub=${fansubItem.id}`} class="select-text text-link">
                  {fansubItem.name}
                </a>
              </div>
            )}
            {after && (
              <div class="space-x-1 select-none">
                <span class="text-base-800 font-bold inline-block">搜索开始于</span>
                <span class="select-text">{format(after, 'yyyy 年 M 月 d 日 hh:mm')}</span>
              </div>
            )}
            {before && (
              <div class="space-x-1 select-none">
                <span class="text-base-800 font-bold inline-block">搜索结束于</span>
                <span class="select-text">{format(before, 'yyyy 年 M 月 d 日 hh:mm')}</span>
              </div>
            )}
            {include && include.length > 0 && (
              <div class="space-x-1 select-none">
                <span class="text-base-800 font-bold inline-block">包含关键词</span>
                {include.map((i) => (
                  <span class="select-text">{i}</span>
                ))}
              </div>
            )}
            {exclude && exclude.length > 0 && (
              <div class="space-x-1">
                <span class="select-none text-base-800 font-bold mr2 inline-block">排除关键词</span>
                {exclude.map((i) => (
                  <span class="select-text">{i}</span>
                ))}
              </div>
            )}
          </div>
        </>
      )
    }
    <ResourceTable resources={resources} />
    <Pagination page={page} href={(page) => `/resources/${page}${url.search}`} />
  </div>
</Layout>
