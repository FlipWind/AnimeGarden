---
import Layout from '../../layouts/Layout.astro';
import Pagination from '../../components/Pagination.astro';
import ResourceTable from '../../components/ResourceTable.astro';

import { fetchResources } from '../../fetch';
import { QueryType } from '../../constant';

const { page: _page } = Astro.params;
const page = _page ? +_page : 1;

const url = Astro.url;
const publisher = url.searchParams.get('publisher');
const fansub = url.searchParams.get('fansub');
const _type = url.searchParams.get('type');
const type = _type && _type in QueryType ? QueryType[_type] : _type;

const _after = url.searchParams.get('after');
const after = _after ? new Date(_after) : undefined;
const _before = url.searchParams.get('before');
const before = _before ? new Date(_before) : undefined;

const _include = url.searchParams.get('include');
const include = _include ? JSON.parse(_include) : undefined;
const _exclude = url.searchParams.get('exclude');
const exclude = _exclude ? JSON.parse(_exclude) : undefined;

const resources = await fetchResources(page, {
  publisher: publisher ? +publisher : undefined,
  fansub: fansub ? +fansub : undefined,
  type: type ? type : undefined,
  include,
  exclude,
  after,
  before
});
---

<Layout title="所有资源 | Anime Garden">
  <div class="mt-4vh w-full">
    <ResourceTable resources={resources} />
    <Pagination page={page} href={(page) => `/resources/${page}${url.search}`} />
  </div>
</Layout>
